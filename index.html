<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã²ãã–ã‚“ã‹ã‚ã©â‘ ãã‚Šã•ãŒã‚Šã®ãªã„ ã²ãã–ã‚“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            /* èƒŒæ™¯ã‚’æ°´è‰²ç³»ã«å¤‰æ›´ */
            background-color: #F0F9FF;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
        .shake { animation: shake 0.3s ease-in-out; }
        .dots-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 4px;
            width: fit-content;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://esm.sh/react-dom@^18.2.0/",
    "react/": "https://esm.sh/react@^18.2.0/",
    "react": "https://esm.sh/react@^18.2.0"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // --- Types & Constants ---
        const GameMode = {
            SEQUENTIAL_ASC: 'SEQUENTIAL_ASC',
            SEQUENTIAL_DESC: 'SEQUENTIAL_DESC',
            RANDOM_10: 'RANDOM_10',
            RANDOM_20: 'RANDOM_20'
        };

        // --- Audio Service ---
        const audioService = {
            ctx: null,
            init() {
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            playCorrect() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1046.50, this.ctx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            },
            playWrong() {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.3);
            }
        };

        // --- Math Utils ---
        const generateSubtractionPool = () => {
            const pool = [];
            // 0-0=0 ã‹ã‚‰ 10-10=0 ã¾ã§ã®ãã‚Šã•ãŒã‚Šã®ãªã„å¼•ãç®—
            // å¼•ã‹ã‚Œã‚‹æ•° a ã¯ 0ã€œ10
            for (let a = 0; a <= 10; a++) {
                // å¼•ãæ•° b ã¯ 0ã€œ10
                for (let b = 0; b <= 10; b++) {
                    // ç­”ãˆãŒ0ä»¥ä¸Šã«ãªã‚‹ã‚‚ã®ï¼ˆãã‚Šã•ãŒã‚Šãªã—ï¼‰
                    if (a - b >= 0) {
                        pool.push({ val1: a, val2: b, answer: a - b });
                    }
                }
            }
            return pool;
        };

        const shuffleArray = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        // --- Components ---

        const Home = ({ onStart, onShowHistory, soundEnabled, toggleSound, dotsEnabled, toggleDots, historyCount }) => (
            <div className="flex flex-col items-center justify-center min-h-screen p-4 text-center">
                {/* æ ç·šã‚’æ°´è‰²ã«å¤‰æ›´ */}
                <div className="bg-white p-6 rounded-[40px] shadow-xl max-w-sm w-full border-4 border-sky-200">
                    {/* ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ°´è‰²ã«å¤‰æ›´ã—ã€å†…å®¹ã‚’ã€Œã²ãã–ã‚“â‘ ã€ã¸ */}
                    <h1 className="text-3xl font-extrabold text-sky-600 mb-1">ã²ãã–ã‚“ã‹ã‚ã©â‘ </h1>
                    <h2 className="text-xl font-bold text-orange-400 mb-6">ãã‚Šã•ãŒã‚Šã®ãªã„ ã²ãã–ã‚“</h2>
                     
                    <div className="space-y-3 w-full">
                        {/* ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’å¤‰æ›´ */}
                        <button onClick={() => onStart(GameMode.SEQUENTIAL_ASC)} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-md transition active:scale-95 text-lg">
                            ã˜ã‚…ã‚“ã°ã‚“ (0-0ã¯ã˜ã¾ã‚Š)
                        </button>
                        <button onClick={() => onStart(GameMode.SEQUENTIAL_DESC)} className="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3.5 rounded-2xl shadow-md transition active:scale-95 text-lg">
                            ãã‚ƒãã˜ã‚…ã‚“ (10-10ã¯ã˜ã¾ã‚Š)
                        </button>
                        <button onClick={() => onStart(GameMode.RANDOM_10)} className="w-full bg-orange-400 hover:bg-orange-500 text-white font-bold py-3.5 rounded-2xl shadow-md transition active:scale-95 text-lg">
                            ãƒ©ãƒ³ãƒ€ãƒ  10å•
                        </button>
                        <button onClick={() => onStart(GameMode.RANDOM_20)} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3.5 rounded-2xl shadow-md transition active:scale-95 text-lg">
                            ãƒ©ãƒ³ãƒ€ãƒ  20å•
                        </button>
                    </div>

                    <div className="mt-6 flex flex-col space-y-3">
                        <div className="flex items-center justify-between px-4">
                            <span className="text-gray-500 font-bold text-sm">ã‚µã‚¦ãƒ³ãƒ‰</span>
                            {/* ONã®è‰²ã‚’æ°´è‰²ã«å¤‰æ›´ */}
                            <button onClick={toggleSound} className={`w-28 py-1.5 rounded-full font-bold text-sm transition ${soundEnabled ? 'bg-sky-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                {soundEnabled ? 'ON ğŸ”Š' : 'OFF ğŸ”ˆ'}
                            </button>
                        </div>
                        <div className="flex items-center justify-between px-4">
                            <span className="text-gray-500 font-bold text-sm">ãƒ’ãƒ³ãƒˆ</span>
                            <button onClick={toggleDots} className={`w-28 py-1.5 rounded-full font-bold text-sm transition ${dotsEnabled ? 'bg-orange-400 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                {dotsEnabled ? 'ã‚ã‚Š â—' : 'ãªã— â—‹'}
                            </button>
                        </div>
                    </div>

                    <div className="mt-6 pt-4 border-t border-gray-100">
                        <button onClick={onShowHistory} className="w-full flex items-center justify-between px-4 py-2 bg-gray-50 hover:bg-gray-100 rounded-xl transition group">
                            <div className="text-left">
                                <div className="text-xs text-gray-400 font-bold">ã“ã‚Œã¾ã§ã®ãã‚ã</div>
                                <div className="text-sm font-bold text-gray-600">{historyCount}ä»¶ ä¿å­˜æ¸ˆã¿</div>
                            </div>
                            {/* ã€Œã¿ã‚‹â†’ã€ã®è‰²ã‚’æ°´è‰²ã«å¤‰æ›´ */}
                            <span className="text-sky-500 font-bold text-sm group-hover:translate-x-1 transition">ã¿ã‚‹ â†’</span>
                        </button>
                    </div>
                </div>
            </div>
        );

        const HistoryPage = ({ history, onBack, onDeleteItem, onClearAll }) => {
            const [confirmClear, setConfirmClear] = useState(false);

            const formatDate = (isoString) => {
                const d = new Date(isoString);
                return `${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
            };

            const getStamp = (correct, total, wrong) => {
                const score = total - wrong;
                const rate = score / total;
                
                if (wrong === 0) return 'ğŸ’®';
                if (rate >= 0.8) return 'ğŸ‰';
                return 'ğŸ‘';
            };

            const calculateAccuracy = (total, wrong) => {
                const score = total - wrong;
                const acc = Math.round((score / total) * 100);
                return Math.max(0, acc);
            };

            return (
                // èƒŒæ™¯ã‚’æ°´è‰²ç³»ã«å¤‰æ›´
                <div className="flex flex-col min-h-[100svh] bg-sky-50">
                    <div className="p-4 bg-white shadow-sm flex items-center justify-between z-10">
                        {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æ°´è‰²ã«å¤‰æ›´ */}
                        <button onClick={onBack} className="text-sky-600 font-bold px-3 py-1 hover:bg-sky-50 rounded-lg transition text-sm">â† ã‚‚ã©ã‚‹</button>
                        <h2 className="text-lg font-black text-gray-700">ãã‚ã</h2>
                        <div className="w-16"></div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 pb-[env(safe-area-inset-bottom)]">
                        {history.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-gray-400 space-y-2">
                                <div className="text-4xl">ğŸ“­</div>
                                <p className="font-bold">ã¾ã  ãã‚ããŒ ã‚ã‚Šã¾ã›ã‚“</p>
                            </div>
                        ) : (
                            <div className="max-w-md mx-auto space-y-2 pb-20">
                                <div className="grid grid-cols-12 gap-2 px-4 text-xs font-bold text-gray-400 mb-1">
                                    <div className="col-span-2 text-center">ã‚¹ã‚¿ãƒ³ãƒ—</div>
                                    <div className="col-span-4">æ—¥æ™‚</div>
                                    <div className="col-span-2 text-center">æ­£ç­”ç‡</div>
                                    <div className="col-span-2 text-center">ã‚¿ã‚¤ãƒ </div>
                                    <div className="col-span-2 text-center">ãƒ’ãƒ³ãƒˆ</div>
                                </div>
                                 
                                {history.map((item, index) => {
                                    const acc = calculateAccuracy(item.total, item.wrong);
                                    return (
                                        <div key={index} className="bg-white rounded-xl shadow-sm border border-slate-100 relative overflow-hidden group flex flex-col">
                                            <div className="grid grid-cols-12 gap-2 p-3 items-center">
                                                <div className="col-span-2 flex justify-center text-2xl">
                                                    {getStamp(item.correct, item.total, item.wrong)}
                                                </div>
                                                <div className="col-span-4 flex flex-col justify-center">
                                                    <div className="text-sm font-bold text-gray-700">{formatDate(item.date).split(' ')[0]}</div>
                                                    <div className="text-xs text-gray-400">{formatDate(item.date).split(' ')[1]}</div>
                                                </div>
                                                <div className="col-span-2 flex justify-center items-center">
                                                    {/* æ­£ç­”ç‡ã®è‰²ã‚’æ°´è‰²ç³»ã« */}
                                                    <div className={`font-black text-lg ${acc >= 80 ? 'text-orange-500' : 'text-sky-500'}`}>
                                                        {acc}<span className="text-[10px]">%</span>
                                                    </div>
                                                </div>
                                                <div className="col-span-2 flex justify-center text-xs font-bold text-gray-500">
                                                    {Math.floor(item.timeMs / 1000)}ç§’
                                                </div>
                                                <div className="col-span-2 flex justify-center">
                                                    <span className={`text-sm ${item.dotsEnabled ? 'text-orange-400' : 'text-gray-300'}`}>
                                                        {item.dotsEnabled ? 'â—' : 'â—‹'}
                                                    </span>
                                                </div>
                                            </div>
                                            {item.wrongProblems && item.wrongProblems.length > 0 && (
                                                <div className="px-3 pb-3 pt-0 border-t border-gray-50 mt-[-4px]">
                                                    <div className="text-[10px] text-gray-400 font-bold mb-1 mt-2">ã¾ã¡ãŒãˆãŸå•é¡Œ:</div>
                                                    <div className="flex flex-wrap gap-1">
                                                        {item.wrongProblems.map((p, i) => (
                                                            // é–“é•ãˆãŸå•é¡Œã®è¡¨ç¤ºã‚’ã€Œ-ã€ã«å¤‰æ›´
                                                            <span key={i} className="text-xs font-bold text-red-500 bg-red-50 px-1.5 py-0.5 rounded border border-red-100">
                                                                {p.val1}-{p.val2}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onDeleteItem(index); }}
                                                className="absolute top-0 right-0 bottom-0 w-8 bg-red-50 text-red-500 flex items-center justify-center opacity-0 group-hover:opacity-100 transition hover:bg-red-100 font-bold z-10"
                                            >
                                                Ã—
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                    {history.length > 0 && (
                        <div className="p-4 bg-white border-t border-gray-100 text-center pb-[env(safe-area-inset-bottom)]">
                            {!confirmClear ? (
                                <button onClick={() => setConfirmClear(true)} className="text-red-400 text-sm font-bold hover:text-red-600 transition">
                                    ğŸ—‘ï¸ ã™ã¹ã¦ã®ãã‚ãã‚’æ¶ˆã™
                                </button>
                            ) : (
                                <div className="flex items-center justify-center gap-4">
                                    <span className="text-sm font-bold text-gray-600">æœ¬å½“ã«æ¶ˆã—ã¾ã™ã‹ï¼Ÿ</span>
                                    <button onClick={onClearAll} className="bg-red-500 text-white px-4 py-1.5 rounded-full text-xs font-bold hover:bg-red-600">ã¯ã„</button>
                                    <button onClick={() => setConfirmClear(false)} className="bg-gray-200 text-gray-600 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-gray-300">ã„ã„ãˆ</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const Game = ({ problems, soundEnabled, dotsEnabled, onFinish, onBack }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [correctCount, setCorrectCount] = useState(0);
            const [wrongCount, setWrongCount] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [isAnimating, setIsAnimating] = useState(false);
            const [missedIndices, setMissedIndices] = useState(new Set());
            const startTimeRef = useRef(Date.now());

            const currentProblem = problems[currentIndex];

            const handleAnswer = useCallback((val) => {
                if (isAnimating || feedback === 'correct') return;

                if (val === currentProblem.answer) {
                    if (soundEnabled) audioService.playCorrect();
                    setFeedback('correct');
                    const nextCorrect = correctCount + 1;
                    setCorrectCount(nextCorrect);
                    setIsAnimating(true);
                    
                    setTimeout(() => {
                        if (currentIndex + 1 < problems.length) {
                            setCurrentIndex(prev => prev + 1);
                            setFeedback(null);
                            setIsAnimating(false);
                        } else {
                            const uniqueWrongs = missedIndices.size;
                            const uniqueCorrects = problems.length - uniqueWrongs;
                            
                            onFinish(
                                uniqueCorrects, 
                                uniqueWrongs, 
                                Date.now() - startTimeRef.current, 
                                Array.from(missedIndices).map(idx => problems[idx])
                            );
                        }
                    }, 600);
                } else {
                    if (soundEnabled) audioService.playWrong();
                    setFeedback('wrong');
                    setWrongCount(prev => prev + 1);
                    setMissedIndices(prev => new Set(prev).add(currentIndex));
                    setTimeout(() => setFeedback(null), 500);
                }
            }, [currentIndex, currentProblem, problems, soundEnabled, correctCount, wrongCount, isAnimating, feedback, missedIndices, onFinish]);

            const renderDots = (num, colorClass) => {
                if (!dotsEnabled) return null;
                if (num === 0) return <div className="flex flex-col items-center justify-end min-h-[5rem] mb-2"></div>;

                const containerClass = "flex flex-col items-center justify-end min-h-[5rem] mb-2";
                
                return (
                    <div className={containerClass}>
                        <div className="dots-grid">
                            {[...Array(num)].map((_, i) => (
                                <span key={i} className={`text-sm leading-none ${colorClass}`}>â—</span>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="p-4 pb-[env(safe-area-inset-bottom)] bg-white rounded-t-[32px] shadow-lg">
                    <div className="p-3 flex justify-between items-center bg-white shadow-sm">
                        {/* æˆ»ã‚‹ãƒœã‚¿ãƒ³ãªã©ã‚’æ°´è‰²ç³»ã« */}
                        <button onClick={onBack} className="text-sky-600 font-bold px-3 py-1 hover:bg-sky-50 rounded-lg transition text-sm">â† ã‚‚ã©ã‚‹</button>
                        <div className="text-sm font-bold text-sky-600">{currentIndex + 1} / {problems.length}</div>
                        <div className="text-sm font-bold flex gap-3">
                            <span className="text-green-500">ã€‡ {correctCount}</span>
                            <span className="text-red-500">Ã— {wrongCount}</span>
                        </div>
                    </div>
                    <div className="w-full h-1 bg-gray-100">
                        {/* é€²æ—ãƒãƒ¼ã‚’æ°´è‰²ã« */}
                        <div className="h-full bg-sky-400 transition-all duration-300" style={{ width: `${((currentIndex + 1) / problems.length) * 100}%` }} />
                    </div>
                    <div className="flex-1 flex items-center justify-center p-4 relative">
                        {/* å•é¡Œã‚«ãƒ¼ãƒ‰ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’æ°´è‰²ã« */}
                        <div className={`bg-white w-full max-w-sm aspect-[4/3] rounded-[32px] shadow-xl border-4 flex flex-col items-center justify-center relative transition-all duration-300 ${feedback === 'correct' ? 'border-green-400 scale-105' : feedback === 'wrong' ? 'border-red-400 shake' : 'border-sky-100'}`}>
                            
                            <div className="flex items-end justify-center gap-2 md:gap-4 pb-4">
                                <div className="flex flex-col items-center">
                                    {renderDots(currentProblem.val1, 'text-orange-400')}
                                    <div className="text-6xl md:text-8xl font-black text-gray-800 leading-none">{currentProblem.val1}</div>
                                </div>
                                
                                <div className="flex flex-col items-center justify-end pb-2 md:pb-4">
                                    {/* è¨ˆç®—è¨˜å·ã‚’ã€Œ-ã€ã«ã€è‰²ã‚’æ°´è‰²ã« */}
                                    <div className="text-4xl md:text-6xl font-black text-sky-400 px-2">-</div>
                                </div>
                                
                                <div className="flex flex-col items-center">
                                    {/* å³å´ã®ãƒ‰ãƒƒãƒˆã®è‰²ã‚’æ°´è‰²ã« */}
                                    {renderDots(currentProblem.val2, 'text-sky-400')}
                                    <div className="text-6xl md:text-8xl font-black text-gray-800 leading-none">{currentProblem.val2}</div>
                                </div>
                            </div>

                            {feedback && <div className={`absolute inset-0 flex items-center justify-center pointer-events-none opacity-20 text-[12rem] ${feedback === 'correct' ? 'text-green-400' : 'text-red-400'}`}>{feedback === 'correct' ? 'ã€‡' : 'Ã—'}</div>}
                        </div>
                    </div>
                    <div className="p-4 pb-8 bg-white rounded-t-[32px] shadow-lg">
                        {/* 0ã€œ10ã®ãƒœã‚¿ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆ2æ®µï¼‰ */}
                        <div className="grid grid-cols-6 gap-2 max-w-sm mx-auto">
                            {[0, 1, 2, 3, 4, 5].map(num => (
                                <button key={num} onClick={() => handleAnswer(num)} disabled={isAnimating} className="w-full aspect-square flex items-center justify-center text-xl font-bold rounded-xl shadow-sm bg-orange-50 text-orange-600 active:scale-90 transition">
                                    {num}
                                </button>
                            ))}
                        </div>
                        <div className="grid grid-cols-5 gap-2 max-w-sm mx-auto mt-2">
                             {[6, 7, 8, 9, 10].map(num => (
                                <button key={num} onClick={() => handleAnswer(num)} disabled={isAnimating} className="w-full aspect-square flex items-center justify-center text-xl font-bold rounded-xl shadow-sm bg-orange-50 text-orange-600 active:scale-90 transition">
                                    {num}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const Result = ({ correct, wrong, total, timeMs, dotsEnabled, wrongProblems, mode, onRestart, onShowHistory }) => {
            const finalScore = total - wrong;
            const accuracy = Math.round((finalScore / total) * 100);
            const timeStr = `${Math.floor(timeMs / 60000) > 0 ? Math.floor(timeMs / 60000) + 'åˆ†' : ''}${Math.floor((timeMs % 60000) / 1000)}ç§’`;

            return (
                // èƒŒæ™¯ã‚’æ°´è‰²ç³»ã«
                <div className="flex flex-col items-center justify-start min-h-[100svh] bg-sky-50 p-4 overflow-y-auto">
                    {/* æ ç·šã‚’æ°´è‰²ç³»ã« */}
                    <div className="bg-white p-6 rounded-[32px] shadow-xl max-w-sm w-full border-4 border-sky-300 relative my-4">
                        <h2 className="text-xl font-black text-gray-700 mb-4 text-center">ã‘ã£ã‹</h2>
                        <div className="flex flex-col items-center mb-4">
                            <div className="text-6xl mb-1 animate-bounce">{accuracy === 100 ? 'ğŸ’®' : accuracy >= 80 ? 'ğŸ‰' : 'ğŸ‘'}</div>
                            <p className="text-lg font-black text-orange-500">{accuracy === 100 ? 'ãŸã„ã¸ã‚“ã‚ˆãã§ãã¾ã—ãŸï¼' : 'ãŒã‚“ã°ã£ãŸã­ï¼'}</p>
                        </div>
                        <div className="space-y-2 mb-6 bg-gray-50 p-4 rounded-2xl text-sm font-bold">
                            <div className="flex justify-between border-b pb-1"><span>ã‚¿ã‚¤ãƒ </span><span className="text-blue-600">{timeStr}</span></div>
                            <div className="flex justify-between border-b pb-1 pt-1"><span>æ­£è§£ã‚¹ã‚³ã‚¢</span><span className="text-xl text-orange-500">{finalScore} / {total}</span></div>
                            <div className="flex justify-between text-xs text-gray-400"><span>ã¾ã¡ãŒã„: {wrong}å›</span><span>æ­£ç­”ç‡: {accuracy}%</span></div>
                        </div>
                        {wrongProblems.length > 0 && (
                            <div className="mb-6">
                                <h3 className="text-xs font-bold text-gray-400 mb-2 border-b">ğŸ“ ã¾ã¡ãŒãˆãŸ ã‚‚ã‚“ã ã„</h3>
                                <div className="flex flex-wrap gap-1.5 max-h-24 overflow-y-auto pr-1">
                                    {/* é–“é•ãˆãŸå•é¡Œã®è¡¨ç¤ºã‚’ã€Œ-ã€ã« */}
                                    {wrongProblems.map((p, i) => <div key={i} className="bg-red-50 text-red-600 px-2 py-0.5 rounded text-xs font-bold">{p.val1}-{p.val2}</div>)}
                                </div>
                            </div>
                        )}
                        <div className="space-y-3">
                            <button onClick={onShowHistory} className="w-full bg-orange-100 text-orange-600 py-3 rounded-2xl font-bold hover:bg-orange-200 transition">
                                ğŸ“‹ ãã‚ãã‚’ã¿ã‚‹
                            </button>
                            {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚’æ°´è‰²ã« */}
                            <button onClick={onRestart} className="w-full bg-sky-500 text-white py-4 rounded-2xl shadow-md text-xl font-black active:scale-95 transition">
                                ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã‚‚ã©ã‚‹
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [screen, setScreen] = useState('HOME');
            const [mode, setMode] = useState('');
            const [problems, setProblems] = useState([]);
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [dotsEnabled, setDotsEnabled] = useState(true);
            const [history, setHistory] = useState([]);
            const [lastResult, setLastResult] = useState(null);

            // ä¿å­˜ã‚­ãƒ¼ã‚’ã€Œã²ãã–ã‚“1ã€ç”¨ã«å¤‰æ›´
            const STORAGE_KEY = 'math_subtraction_no_carry_history_v1';

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) setHistory(JSON.parse(saved));
            }, []);

            const updateHistory = (newHistory) => {
                setHistory(newHistory);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newHistory));
            };

            const startGame = (selectedMode) => {
                // å¼•ãç®—ã®å•é¡Œãƒ—ãƒ¼ãƒ«ã‚’ç”Ÿæˆ
                const pool = generateSubtractionPool();
                let selected = [];
                let modeLabel = '';
                
                if (selectedMode === GameMode.SEQUENTIAL_ASC) {
                    // å¼•ã‹ã‚Œã‚‹æ•°(val1)ãŒå°ã•ã„é †ã€åŒã˜ãªã‚‰å¼•ãæ•°(val2)ãŒå°ã•ã„é †
                    selected = [...pool].sort((a,b) => a.val1 !== b.val1 ? a.val1 - b.val1 : a.val2 - b.val2);
                    modeLabel = 'ã˜ã‚…ã‚“ã°ã‚“';
                } else if (selectedMode === GameMode.SEQUENTIAL_DESC) {
                    // å¼•ã‹ã‚Œã‚‹æ•°(val1)ãŒå¤§ãã„é †ã€åŒã˜ãªã‚‰å¼•ãæ•°(val2)ãŒå¤§ãã„é †
                    selected = [...pool].sort((a,b) => a.val1 !== b.val1 ? b.val1 - a.val1 : b.val2 - a.val2);
                    modeLabel = 'ãã‚ƒãã˜ã‚…ã‚“';
                } else {
                    selected = shuffleArray(pool).slice(0, selectedMode === GameMode.RANDOM_10 ? 10 : 20);
                    modeLabel = selectedMode === GameMode.RANDOM_10 ? 'ãƒ©ãƒ³ãƒ€ãƒ 10' : 'ãƒ©ãƒ³ãƒ€ãƒ 20';
                }
                
                setMode(modeLabel);
                setProblems(selected);
                setScreen('GAME');
            };

            const finishGame = (correct, wrong, timeMs, wrongProblems) => {
                const result = { correct, wrong, total: problems.length, timeMs, mode, dotsEnabled, wrongProblems, date: new Date().toISOString() };
                const newHistory = [result, ...history].slice(0, 100);
                updateHistory(newHistory);
                setLastResult(result);
                setScreen('RESULT');
            };

            const handleDeleteItem = (index) => {
                const newHistory = history.filter((_, i) => i !== index);
                updateHistory(newHistory);
            };

            const handleClearAll = () => {
                updateHistory([]);
            };

            return (
                // å…¨ä½“ã®èƒŒæ™¯è‰²ã‚’æ°´è‰²ç³»ã«çµ±ä¸€
                <div className="min-h-[100svh] w-screen bg-sky-50 font-sans select-none text-gray-800">
                    {screen === 'HOME' && (
                        <Home 
                            onStart={startGame} 
                            onShowHistory={() => setScreen('HISTORY')}
                            soundEnabled={soundEnabled} 
                            toggleSound={() => setSoundEnabled(!soundEnabled)} 
                            dotsEnabled={dotsEnabled} 
                            toggleDots={() => setDotsEnabled(!dotsEnabled)} 
                            historyCount={history.length} 
                        />
                    )}
                    {screen === 'GAME' && (
                        <Game 
                            problems={problems} 
                            soundEnabled={soundEnabled} 
                            dotsEnabled={dotsEnabled} 
                            onFinish={finishGame} 
                            onBack={() => setScreen('HOME')} 
                        />
                    )}
                    {screen === 'RESULT' && (
                        <Result 
                            {...lastResult} 
                            onRestart={() => setScreen('HOME')} 
                            onShowHistory={() => setScreen('HISTORY')}
                        />
                    )}
                    {screen === 'HISTORY' && (
                        <HistoryPage 
                            history={history} 
                            onBack={() => setScreen('HOME')} 
                            onDeleteItem={handleDeleteItem}
                            onClearAll={handleClearAll}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
